# Estrai la chiave dall'header personalizzato
map $http_apikey $api_key_valid {
    default 0;
    your-api-key 1;
}

server {
    listen 80;

    # Overpass CGI
    location /api/ {
        # Blocco se chiave non valida
        if ($api_key_valid = 0) {
            return 401; # Non autorizzato
        }

        alias /usr/local/overpass/cgi-bin/;
        #gzip on;
        #gzip_types application/json application/osm3s+xml;

        # set the minimum length that will be compressed
        #gzip_min_length 1000; # in bytes

        # Fastcgi socket
        fastcgi_pass unix:/var/run/fcgiwrap.socket;

        # Fastcgi parameters, include the standard ones
        include /etc/nginx/fastcgi_params;
        # Parametri necessari
        fastcgi_param SCRIPT_FILENAME $request_filename;
        fastcgi_param QUERY_STRING    $query_string;
        fastcgi_param REQUEST_METHOD  $request_method;
        fastcgi_param CONTENT_TYPE    $content_type;
        fastcgi_param CONTENT_LENGTH  $content_length;
    }
}